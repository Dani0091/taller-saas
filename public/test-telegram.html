<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Telegram + OCR</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 { color: #333; margin-top: 0; }
    input[type="file"] {
      padding: 10px;
      margin: 15px 0;
      border: 2px solid #ddd;
      border-radius: 6px;
      display: block;
      width: 100%;
    }
    button {
      background: #667eea;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      width: 100%;
      margin: 10px 0;
    }
    button:hover { background: #764ba2; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .result {
      margin-top: 20px;
      padding: 15px;
      background: #f0f0f0;
      border-radius: 6px;
      border-left: 4px solid #667eea;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { background: #d4edda; border-left-color: #28a745; color: #155724; }
    .error { background: #f8d7da; border-left-color: #dc3545; color: #721c24; }
    img { max-width: 100%; margin: 15px 0; border-radius: 6px; border: 2px solid #ddd; }
    .status { margin: 10px 0; padding: 10px; background: #e3f2fd; border-radius: 4px; font-weight: 600; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì∏ Test Telegram + OCR</h1>
    <p style="color: #666;">Sube foto de auto/matr√≠cula para OCR autom√°tico</p>

    <input type="file" id="fileInput" accept="image/*" placeholder="Selecciona imagen">
    <button onclick="subirFoto()">üì§ Subir a Telegram + OCR</button>
    
    <div id="status"></div>
    <div id="preview"></div>
    <div id="result"></div>
  </div>

  <script>
    let Tesseract = window.Tesseract
    let worker = null

    async function inicializarTesseract() {
      if (worker) return worker
      console.log('‚è≥ [TESSERACT] Inicializando...')
      worker = await Tesseract.createWorker('spa')
      console.log('‚úÖ [TESSERACT] Listo')
      return worker
    }

    async function extraerOCR(imageUrl) {
      try {
        console.log('üîç [OCR] Procesando imagen via proxy...')
        mostrarStatus('‚è≥ Procesando OCR (primera vez tarda m√°s)...')

        // Usar proxy para evitar CORS
        const proxyUrl = `/api/image/proxy?url=${encodeURIComponent(imageUrl)}`
        console.log('üîó [PROXY] URL:', proxyUrl)

        const w = await inicializarTesseract()
        const result = await w.recognize(proxyUrl)
        
        const texto = result.data.text || ''
        const confianza = Math.round(result.data.confidence) || 0

        console.log('üìù [OCR] Texto:', texto.substring(0, 100))

        // Matr√≠cula espa√±ola
        const matriculaMatch = texto.match(/([A-Z]{2,3})\s*[-]?\s*([0-9]{3,4})\s*[-]?\s*([A-Z]{2,3})/i)
        const matricula = matriculaMatch ? matriculaMatch[0].toUpperCase() : 'No encontrada'

        // KM
        const kmMatch = texto.match(/([0-9]{3,6})\s*(?:km|kms|KM)/i)
        const km = kmMatch ? kmMatch[1] : 'No encontrado'

        console.log('‚úÖ [OCR] Resultado:', { matricula, km, confianza })

        const resultado = `
‚úÖ OCR COMPLETADO CON √âXITO

üöó DATOS EXTRA√çDOS:
  ‚Ä¢ Matr√≠cula: ${matricula}
  ‚Ä¢ KM: ${km}
  ‚Ä¢ Confianza: ${confianza}%

üìù TEXTO COMPLETO:
${texto}

üîó URL Original:
${imageUrl}
        `

        mostrarResultado(resultado, false)
        mostrarStatus('‚úÖ OCR completado exitosamente')
      } catch (error) {
        console.error('‚ùå [OCR] Error:', error)
        mostrarResultado(`‚ùå Error OCR: ${error.message}`, true)
        mostrarStatus('‚ùå Error en OCR')
      }
    }

    async function subirFoto() {
      const file = document.getElementById('fileInput').files?.[0]
      if (!file) {
        mostrarResultado('‚ùå Selecciona una imagen primero', true)
        return
      }

      try {
        mostrarStatus('üì§ Subiendo a Telegram...')
        
        // Preview
        const reader = new FileReader()
        reader.onload = (e) => {
          document.getElementById('preview').innerHTML = `<img src="${e.target.result}" alt="preview">`
        }
        reader.readAsDataURL(file)

        // Upload a Telegram
        const formData = new FormData()
        formData.append('file', file)
        formData.append('ordenId', 'test-001')
        formData.append('tipo', 'entrada')

        const res = await fetch('/api/telegram/upload-photo', {
          method: 'POST',
          body: formData
        })

        const data = await res.json()
        console.log('üì§ [TELEGRAM] Respuesta:', data)

        if (!data.success) throw new Error(data.error)

        mostrarResultado(`‚úÖ Foto subida a Telegram\n\nüîó URL: ${data.imageUrl}`, false)
        
        // OCR
        await extraerOCR(data.imageUrl)
      } catch (error) {
        console.error('‚ùå Error:', error)
        mostrarResultado(`‚ùå Error: ${error.message}`, true)
        mostrarStatus('‚ùå Error')
      }
    }

    function mostrarResultado(text, isError) {
      const resultDiv = document.getElementById('result')
      resultDiv.className = `result ${isError ? 'error' : 'success'}`
      resultDiv.textContent = text
    }

    function mostrarStatus(text) {
      document.getElementById('status').innerHTML = `<div class="status">${text}</div>`
    }
  </script>
</body>
</html>
